# 开发日志与经验记录

## 项目概述

本项目是一个基于Rust的AI系统实践项目，专注于构建从基础到高级的AI服务架构。

## 已完成功能

### 1. 基础架构 (c08_serving_ops)

- ✅ HTTP服务框架基于axum
- ✅ 推理引擎抽象接口 (InferenceEngine trait)
- ✅ 基础的DummyEngine实现
- ✅ 性能指标收集系统 (MetricsCollector)
- ✅ 错误处理中间件
- ✅ CORS支持
- ✅ 优雅关停信号处理

### 2. 数据处理 (c02_data)

- ✅ Min-Max标准化
- ✅ Z-score标准化
- ✅ 数据统计计算 (均值、中位数、四分位数等)
- ✅ 异常值检测与移除 (IQR方法)
- ✅ 数据分箱功能
- ✅ 完整的单元测试

### 3. 机器学习基础 (c03_ml_basics)

- ✅ 线性回归 (闭式解)
- ✅ R²计算
- ✅ K-means聚类 (一维)
- ✅ 高斯朴素贝叶斯分类器
- ✅ 预测和评估功能
- ✅ 全面的测试覆盖

### 4. Candle集成

- ✅ 添加candle依赖
- ✅ 创建CandleEngine结构
- ✅ 实现InferenceEngine trait

## 当前问题与挑战

### 1. HTTP路由问题 🔴

**问题描述**: /embed, /search, /metrics等端点返回404错误
**可能原因**:

- axum版本兼容性问题
- 中间件配置问题
- 路由注册顺序问题
- 状态注入问题

**调试进展**:

- 已确认/healthz和/infer端点正常工作
- 已尝试简化路由配置
- 已检查编译错误（无错误）
- 需要进一步调试axum路由匹配机制

### 2. CandleEngine响应问题 🟡

**问题描述**: 使用CandleEngine后仍然返回"echo:"响应
**可能原因**:

- 缓存问题
- 多个binary问题
- 状态注入未生效

**调试进展**:

- 已确认代码中使用CandleEngine::new()
- 已清理并重新构建
- 需要检查runtime状态

### 3. 测试执行问题 🟡

**问题描述**: 新添加的测试不被执行，只执行第一个测试
**可能原因**:

- 语法错误导致后续测试未编译
- 测试模块配置问题

## 技术决策记录

### 1. 架构选择

- **Web框架**: 选择axum而非actix-web，因为其更好的异步支持和类型安全
- **推理框架**: 选择candle作为主要推理引擎，因为其纯Rust实现和良好的性能
- **序列化**: 使用serde + serde_json进行JSON处理

### 2. 项目结构

- 采用workspace结构，按功能模块分离crate
- 每个crate都有独立的测试和文档
- 统一的依赖管理和构建配置

### 3. 测试策略

- 单元测试：每个函数都有对应测试
- 集成测试：HTTP API端到端测试
- 性能测试：基准测试框架

## 性能优化记录

### 1. 编译优化

- 使用release profile优化设置
- 启用LTO (Link Time Optimization)
- 设置codegen-units = 1
- strip = "symbols" 减小二进制大小

### 2. 运行时优化

- 异步I/O使用tokio
- 内存池化（待实现）
- 连接复用（待实现）

## 下一步计划

### 短期目标 (1-2周)

1. 🔴 解决HTTP路由问题
2. 🟡 修复CandleEngine响应问题
3. 🟡 完善测试执行
4. ⚪ 添加更多深度学习基础功能
5. ⚪ 实现基础RAG功能

### 中期目标 (1个月)

1. 集成真实的预训练模型
2. 实现向量数据库
3. 添加工具调用功能
4. 完善监控和日志
5. 性能基准测试

### 长期目标 (3个月)

1. 多代理系统
2. 工作流编排
3. 分布式部署
4. 安全和合规功能

## 经验教训

### 1. 开发流程

- **渐进式开发**: 先实现基础功能，再添加复杂特性
- **测试驱动**: 每个功能都先写测试，再实现
- **文档同步**: 代码和文档同步更新

### 2. 调试技巧

- **日志先行**: 添加足够的调试日志
- **隔离测试**: 创建最小复现环境
- **版本控制**: 频繁提交，方便回退

### 3. Rust特定经验

- **所有权系统**: 合理使用Arc/Mutex进行状态共享
- **异步编程**: tokio的异步模型需要仔细设计
- **依赖管理**: workspace统一管理依赖版本

## 资源与参考

### 文档

- [Axum官方文档](https://docs.rs/axum/)
- [Candle框架](https://github.com/huggingface/candle)
- [Tokio异步运行时](https://tokio.rs/)

### 最佳实践

- [Rust API指南](https://rust-lang.github.io/api-guidelines/)
- [异步Rust编程](https://rust-lang.github.io/async-book/)

## 更新历史

- 2025-09-17: 初始版本，记录当前状态和主要问题
